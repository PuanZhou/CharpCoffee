@model IEnumerable<prjCSCoffee.Models.CShoppingCartItem>

@{
    ViewData["Title"] = "Maps";
    int count = 0;
    int Total = 0;
}

@section Style
{
    <style>
        h1 {
            margin-top: 150px;
        }
    </style>

}

<h1>Maps</h1>

<div class="container">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#"><i class="fa fa-home"></i> Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Cart</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="progress" style="height: 40px; background-color: #F0F0F0;">
    <div class="progress-bar" role="progressbar" style="width: 33%; font-size: 15px" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">商品確認</div>
    <div class="progress-bar" role="progressbar" style="width: 33%; font-size: 15px; background-color: #BEBEBE " aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">付款方式</div>
    <div class="progress-bar" role="progressbar" style="width: 34%; font-size: 15px; background-color: #BEBEBE " aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">最後確認</div>
</div>


<!-- ##### Cart Area Start ##### -->
<div class="cart-area section-padding-0-100 clearfix">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="cart-table clearfix">
                    <table class="table table-responsive">
                        <thead>
                            <tr>
                                <th>
                                    產品名稱
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.count)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.price)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.小計)
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                foreach (var item in Model)
                                {
                                    count++;
                                    Total += (int)item.小計;
                                    int price = (int)item.price;
                                    int 小計 = (int)item.小計;
                                    <tr>
                                        <td class="cart_product_img">
                                            <input type="hidden" value="@item.productId" name="productId" id="productId" />
                                            @*<a href="#"><img src="img/bg-img/34.jpg" alt="Product"></a>*@
                                            @item.productId
                                            <h5>@item.product.ProductName</h5>
                                        </td>
                                        <td class="qty">
                                            <div class="quantity">
                                                <i class="bi bi-dash-square-fill" id="reduce" name="reduce" style="font-size:20px"></i>
                                                <input type="text" min="1" value="@item.count" id="txtQty" class="txtQty" size="6" readonly />
                                                <i class="bi bi-plus-square-fill" id="plus" name="plus" style="font-size:20px"></i>

                                                @*<span class="qty-minus" onclick="var effect = document.getElementById('qty'); var qty = effect.value; if( !isNaN( qty ) &amp;&amp; qty &gt; 1 ) effect.value--;return false;"><i class="fa fa-minus" aria-hidden="true"></i></span>
                                                    <input type="number" class="qty-text" id="qty" step="1" min="1" max="99" name="quantity" value="1">
                                                    <span class="qty-plus" onclick="var effect = document.getElementById('qty'); var qty = effect.value; if( !isNaN( qty )) effect.value++;return false;"><i class="fa fa-plus" aria-hidden="true"></i></span>*@
                                            </div>
                                        </td>
                                        <td class="price">
                                            <span>
                                                @*<p id="txtprice">NT$@item.price</p>*@
                                                <p id="txtprice">NT$@price</p>
                                            </span>
                                        </td>
                                        <td class="total_price">
                                            <span>
                                                @*<p id="txtcount">NT$@item.小計</p>*@
                                                <p id="txtcount">NT$@小計</p>
                                            </span>
                                        </td>
                                        <td class="action">
                                            @Html.ActionLink("刪除", "Delete", "Shopping", new { id = item.productId },
                            new { onclick = "return confirm('確定要刪除嗎?')", @class = "btn btn-danger" })
                                            @*<a href="#"><i class="icon_close"></i></a>*@
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">

            <!-- Coupon Discount -->
            <div class="col-12 col-lg-6">
                <div class="coupon-discount mt-70">
                    <h5>COUPON DISCOUNT</h5>
                    <p>Coupons can be applied in the cart prior to checkout. Add an eligible item from the booth of the seller that created the coupon code to your cart. Click the green "Apply code" button to add the coupon to your order. The order total will update to indicate the savings specific to the coupon code entered.</p>
                    <form action="#" method="post">
                        <input type="text" name="coupon-code" placeholder="Enter your coupon code">
                        <button type="submit">APPLY COUPON</button>
                    </form>
                </div>
            </div>

            <!-- Cart Totals -->
            <div class="col-12 col-lg-6">
                <div class="cart-totals-area mt-70">
                    <h5 class="title--">Cart Total</h5>
                    <div class="subtotal d-flex justify-content-between">
                        <h5>Subtotal</h5>
                        <h5>$9.99</h5>
                    </div>
                    <div class="shipping d-flex justify-content-between">
                        <h5>Shipping</h5>
                        <div class="shipping-address">
                            <form action="#" method="post">
                                <select class="custom-select">
                                    <option selected>Country</option>
                                    <option value="1">USA</option>
                                    <option value="2">Latvia</option>
                                    <option value="3">Japan</option>
                                    <option value="4">Bangladesh</option>
                                </select>
                                <input type="text" name="shipping-text" id="shipping-text" placeholder="State">
                                <input type="text" name="shipping-zip" id="shipping-zip" placeholder="ZIP">
                                <button type="submit">Update Total</button>
                            </form>
                        </div>
                    </div>
                    <div class="total d-flex justify-content-between">
                        <h5>Total</h5>
                        <h5>$9.99</h5>
                    </div>
                    <div class="checkout-btn">
                        <a href="#" class="btn alazea-btn w-100">PROCEED TO CHECKOUT</a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- ##### Cart Area End ##### -->



@section Scripts
{
    <script>
       //刪除購物車=============================================
        let proid = 0;  //記要刪除ㄉ產品ID
        var deltr;
        $("tbody").on("click", "#btndelete", DELE);
        function DELE() {
            $("#exampleModalCenter").modal("show");
            proid = $(this).parent().find("#productId").val();
            deltr = $(this).closest("tr");
        }

        async function CDelete(id) {
            const response = await fetch("@Url.Content("~/shopping/Delete")" + `?id=${id}`);
            CountCart();
        }

        $("#deletepro").click(function () {
            $('#exampleModalCenter').modal('hide');
            CDelete(proid);
            deltr.remove();
            if ($("tbody>tr").length == 0) {
                window.location.href = '@Url.Content("~/shopping/ShoppingCarEmpty")';
            }

            $.bootstrapGrowl("刪除成功", {
                ele: "body",
                type: "success",
                offset: { from: "bottom", amount: 50 },
                align: "right",
                width: "auto",
                delay: 3000,
                allow_dismiss: true,
                stackup_spacing: 10
            });
            計算購物明細();
        });

        //修改購物車數量=======================================================
        $("tbody").on("click", "#plus", PLUS);
        function PLUS() {
            let id = $(this).parent().parent().prev().find("#productId").val();
            let qty = parseInt($(this).parent().find(".qty-text").val()) + 1;
            let stock = $(this).parent().find("#stock").val();
            if (qty > stock) {
                qty -= 1;
                $.bootstrapGrowl("已達可訂購最高數量", {
                    ele: "body",
                    type: "primary",
                    offset: { from: "bottom", amount: 50 },
                    align: "right",
                    width: "auto",
                    delay: 3000,
                    allow_dismiss: true,
                    stackup_spacing: 10
                });

            }
            else {
                let price = $(this).parent().parent().next().find("#txtprice").text().trim().substring(3);
                let 小計 = ("NT$") + (qty * price);
                $(this).parent().find(".qty-text").val(qty);
                $(this).parent().parent().next().next().find("#txtcount").text(小計);

                計算購物明細();
                CAdd(id);

            }
        }

        $("tbody").on("click", "#reduce", REDUCE);
        function REDUCE() {
            let id = $(this).parent().parent().prev().find("#productId").val();
            let qty = parseInt($(this).parent().find(".qty-text").val()) - 1;
            if (qty < 1) qty = 1;
            else {
                let price = $(this).parent().parent().next().find("#txtprice").text().trim().substring(3);
                let 小計 = ("NT$") + (qty * price);
                $(this).parent().find(".qty-text").val(qty);
                $(this).parent().parent().next().next().find("#txtcount").text(小計);

                計算購物明細();
                CReduce(id);

            }
        }

        function 計算購物明細() {
            //計算總金額=======================================================
            let discount = 0;
            let subtotal = 0;
            let fee = 0;
            let total = 0;
            $("p").filter("#txtcount").each(function () {
                subtotal += parseInt($(this).text().trim().substring(3));
            })
            //判斷運費===========================================================
            if (subtotal < 1200) {
                fee = 100;
                total = subtotal + fee;
                $("#labSubtotal").text("NT$ " + subtotal);
                $("#labDiscount").text("-NT$ " + discount);
                $("#labFee").text("NT$ " + fee);
                $("#labTotal").text("NT$ " + total);
            }
            else if (subtotal >= 1200) {
                fee = 0;
                total = subtotal + fee;
                $("#labSubtotal").text("NT$ " + subtotal);
                $("#labDiscount").text("-NT$ " + discount);
                $("#labFee").text("NT$ " + fee);
                $("#labTotal").text("NT$ " + total);
            }
        }

        async function CAdd(id) {
            const response = await fetch("@Url.Content("~/shopping/plus")" + `?id=${id}`);
            CountCart();
        }
        async function CReduce(id) {
             const response = await fetch("@Url.Content("~/shopping/Reduce")" + `?id=${id}`);
             CountCart();
        }

    </script>

}